FROM node:22.14.0-slim

ENV NODE_ENV=development \
    NODE_OPTIONS=--max-old-space-size=4096 \
    PORT=3002 \
    API_HEALTH_PORT=5001 \
    TREE_SITTER_SKIP_PREBUILD_DOWNLOAD=1 \
    npm_config_build_from_source=true \
    SHELL=/bin/sh

WORKDIR /usr/src/app

# Dependências do sistema
RUN apt-get update && \
    apt-get install -y --no-install-recommends \
      ca-certificates git python3 make g++ pkg-config procps \
    && rm -rf /var/lib/apt/lists/*

# Copiar package / lock
COPY package.json yarn.lock ./

# Instalar dependências
RUN yarn install --network-timeout 600000 \
    && npx --yes node-gyp rebuild -C node_modules/tree-sitter

# Copiar todo o código fonte
COPY . .

# Build inicial (necessário para o worker do piscina)
RUN npx nest build -b swc && npx tsc-alias -p tsconfig.json

EXPOSE ${PORT} ${API_HEALTH_PORT} 9300 9301

# Rodar em modo watch para hot reload
CMD ["yarn", "start:dev"]
